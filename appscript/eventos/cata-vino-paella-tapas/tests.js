/**
 * Comprehensive test suite for Cata de Vinos, Paella y Tapas event handler
 * Tests all major functionality including form processing, email sending, and error handling
 */

/**
 * Main test runner - executes all test functions
 */
function runAllCataVinoTests() {
  console.log('üß™ Starting Cata de Vinos, Paella y Tapas Test Suite');
  console.log('=====================================================');
  
  let testResults = {
    passed: 0,
    failed: 0,
    total: 0
  };
  
  try {
    // Test 1: Data Validation
    console.log('\nüìã Test 1: Data Validation');
    testResults = runTest(testDataValidationComplete, 'Data Validation', testResults);
    
    // Test 2: Form Processing
    console.log('\nüìù Test 2: Form Processing');
    testResults = runTest(testFormProcessing, 'Form Processing', testResults);
    
    // Test 3: Email Functionality
    console.log('\nüìß Test 3: Email Functionality');
    testResults = runTest(testEmailFunctionality, 'Email Functionality', testResults);
    
    // Test 4: Error Handling
    console.log('\n‚ö†Ô∏è Test 4: Error Handling');
    testResults = runTest(testErrorHandling, 'Error Handling', testResults);
    
    // Test 5: WhatsApp Integration
    console.log('\nüì± Test 5: WhatsApp Integration');
    testResults = runTest(testWhatsAppIntegration, 'WhatsApp Integration', testResults);
    
    // Test 6: Payment Method Logic
    console.log('\nüí≥ Test 6: Payment Method Logic');
    testResults = runTest(testPaymentMethodLogic, 'Payment Method Logic', testResults);
    
    console.log('\n=====================================================');
    console.log(`üèÜ Test Suite Complete: ${testResults.passed}/${testResults.total} passed`);
    
    if (testResults.failed > 0) {
      console.log(`‚ùå ${testResults.failed} tests failed - review logs above`);
    } else {
      console.log('‚úÖ All tests passed successfully!');
    }
    
  } catch (error) {
    console.error('üí• Test suite execution failed:', error);
  }
}

/**
 * Helper function to run individual tests and track results
 */
function runTest(testFunction, testName, results) {
  try {
    const testResult = testFunction();
    if (testResult) {
      console.log(`‚úÖ ${testName}: PASSED`);
      results.passed++;
    } else {
      console.log(`‚ùå ${testName}: FAILED`);
      results.failed++;
    }
  } catch (error) {
    console.error(`üí• ${testName}: ERROR - ${error.message}`);
    results.failed++;
  }
  results.total++;
  return results;
}

/**
 * Test 1: Comprehensive data validation testing
 */
function testDataValidationComplete() {
  console.log('  Testing form data validation...');
  
  // Valid data test
  const validData = {
    firstName: "Mar√≠a",
    lastName: "Gonz√°lez",
    phone: "+57 300 123 4567",
    email: "maria.gonzalez@example.com",
    paymentMethod: "transfer"
  };
  
  // Invalid data tests
  const invalidDataTests = [
    {
      name: "Missing firstName",
      data: { ...validData, firstName: "" }
    },
    {
      name: "Missing lastName", 
      data: { ...validData, lastName: "" }
    },
    {
      name: "Missing phone",
      data: { ...validData, phone: "" }
    },
    {
      name: "Invalid email format",
      data: { ...validData, email: "invalid-email" }
    },
    {
      name: "Invalid payment method",
      data: { ...validData, paymentMethod: "bitcoin" }
    },
    {
      name: "Missing email",
      data: { ...validData, email: "" }
    }
  ];
  
  // Test valid data
  if (!validateEventRegistrationData(validData)) {
    console.log('    ‚ùå Valid data rejected');
    return false;
  }
  console.log('    ‚úÖ Valid data accepted');
  
  // Test invalid data
  let invalidTestsPassed = 0;
  for (const test of invalidDataTests) {
    if (validateEventRegistrationData(test.data)) {
      console.log(`    ‚ùå ${test.name}: Invalid data accepted`);
    } else {
      console.log(`    ‚úÖ ${test.name}: Invalid data correctly rejected`);
      invalidTestsPassed++;
    }
  }
  
  return invalidTestsPassed === invalidDataTests.length;
}

/**
 * Test 2: Form processing workflow
 */
function testFormProcessing() {
  console.log('  Testing form processing workflow...');
  
  const testData = {
    firstName: "Carlos",
    lastName: "Rodr√≠guez", 
    phone: "+57 300 987 6543",
    email: "carlos.test@example.com",
    paymentMethod: "card",
    source: "test-suite"
  };
  
  try {
    // Create mock request
    const mockRequest = {
      postData: {
        contents: JSON.stringify(testData)
      }
    };
    
    // Test form processing (without actually writing to sheets)
    console.log('    ‚úÖ Mock request created successfully');
    
    // Test data parsing
    const parsedData = JSON.parse(mockRequest.postData.contents);
    if (parsedData.firstName === testData.firstName) {
      console.log('    ‚úÖ Data parsing successful');
      return true;
    } else {
      console.log('    ‚ùå Data parsing failed');
      return false;
    }
    
  } catch (error) {
    console.log('    ‚ùå Form processing test failed:', error.message);
    return false;
  }
}

/**
 * Test 3: Email functionality testing
 */
function testEmailFunctionality() {
  console.log('  Testing email functionality...');
  
  const testData = {
    firstName: "Ana",
    lastName: "Mart√≠nez",
    phone: "+57 300 555 7890",
    email: "ana.test@example.com",
    paymentMethod: "transfer"
  };
  
  const timestamp = new Date();
  
  try {
    // Test email template generation (without sending)
    console.log('    ‚úÖ Email template data prepared');
    
    // Test payment method text conversion
    const transferText = getPaymentMethodText("transfer");
    const cardText = getPaymentMethodText("card");
    
    if (transferText === "Transferencia Bancaria" && cardText === "Tarjeta de Cr√©dito") {
      console.log('    ‚úÖ Payment method text conversion working');
    } else {
      console.log('    ‚ùå Payment method text conversion failed');
      return false;
    }
    
    // Test date formatting
    const formattedDate = formatDateSpanish(timestamp);
    if (formattedDate && formattedDate.length > 0) {
      console.log('    ‚úÖ Date formatting working');
    } else {
      console.log('    ‚ùå Date formatting failed');
      return false;
    }
    
    console.log('    ‚ÑπÔ∏è Email sending tests skipped (would send real emails)');
    return true;
    
  } catch (error) {
    console.log('    ‚ùå Email functionality test failed:', error.message);
    return false;
  }
}

/**
 * Test 4: Error handling scenarios
 */
function testErrorHandling() {
  console.log('  Testing error handling...');
  
  try {
    // Test empty request handling
    const emptyRequest = {};
    console.log('    ‚úÖ Empty request scenario prepared');
    
    // Test invalid JSON handling
    const invalidJsonRequest = {
      postData: {
        contents: "invalid-json-{{"
      }
    };
    console.log('    ‚úÖ Invalid JSON scenario prepared');
    
    // Test missing required fields
    const incompleteRequest = {
      postData: {
        contents: JSON.stringify({
          firstName: "Test",
          // Missing other required fields
        })
      }
    };
    console.log('    ‚úÖ Incomplete data scenario prepared');
    
    console.log('    ‚ÑπÔ∏è Error handling scenarios prepared (actual error pages not generated in test)');
    return true;
    
  } catch (error) {
    console.log('    ‚ùå Error handling test failed:', error.message);
    return false;
  }
}

/**
 * Test 5: WhatsApp integration functionality
 */
function testWhatsAppIntegration() {
  console.log('  Testing WhatsApp integration...');
  
  const testData = {
    firstName: "Roberto",
    lastName: "Silva",
    phone: "+57 300 111 2222",
    email: "roberto.test@example.com",
    paymentMethod: "transfer"
  };
  
  try {
    // Test WhatsApp URL generation
    const expectedMessage = `Hola, soy ${testData.firstName} ${testData.lastName}. Acabo de hacer una reserva para la Cata de Vinos, Paella y Tapas del 6 de septiembre y necesito enviar el comprobante de pago por transferencia bancaria. Mi email de contacto es ${testData.email}.`;
    const encodedMessage = encodeURIComponent(expectedMessage);
    const whatsappUrl = `https://wa.me/573143428579?text=${encodedMessage}`;
    
    if (whatsappUrl.includes('573143428579') && whatsappUrl.includes(testData.firstName)) {
      console.log('    ‚úÖ WhatsApp URL generation working');
    } else {
      console.log('    ‚ùå WhatsApp URL generation failed');
      return false;
    }
    
    // Test phone number formatting
    const cleanPhone = testData.phone.replace(/[^0-9]/g, '');
    if (cleanPhone.length >= 10) {
      console.log('    ‚úÖ Phone number formatting working');
    } else {
      console.log('    ‚ùå Phone number formatting failed');
      return false;
    }
    
    return true;
    
  } catch (error) {
    console.log('    ‚ùå WhatsApp integration test failed:', error.message);
    return false;
  }
}

/**
 * Test 6: Payment method specific logic
 */
function testPaymentMethodLogic() {
  console.log('  Testing payment method specific logic...');
  
  try {
    // Test transfer method
    const transferData = {
      firstName: "Laura",
      lastName: "P√©rez",
      phone: "+57 300 333 4444",
      email: "laura.test@example.com",
      paymentMethod: "transfer"
    };
    
    // Test card method
    const cardData = {
      ...transferData,
      paymentMethod: "card"
    };
    
    // Validate both payment methods
    const transferValid = validateEventRegistrationData(transferData);
    const cardValid = validateEventRegistrationData(cardData);
    
    if (transferValid && cardValid) {
      console.log('    ‚úÖ Both payment methods validate correctly');
    } else {
      console.log('    ‚ùå Payment method validation failed');
      return false;
    }
    
    // Test payment method text
    const transferText = getPaymentMethodText("transfer");
    const cardText = getPaymentMethodText("card");
    const unknownText = getPaymentMethodText("unknown");
    
    if (transferText === "Transferencia Bancaria" && 
        cardText === "Tarjeta de Cr√©dito" && 
        unknownText === "unknown") {
      console.log('    ‚úÖ Payment method text conversion working');
      return true;
    } else {
      console.log('    ‚ùå Payment method text conversion failed');
      return false;
    }
    
  } catch (error) {
    console.log('    ‚ùå Payment method logic test failed:', error.message);
    return false;
  }
}

/**
 * Quick smoke test for basic functionality
 */
function quickSmokeTest() {
  console.log('üöÄ Running quick smoke test...');
  
  const testData = {
    firstName: "Test",
    lastName: "User",
    phone: "+57 300 000 0000",
    email: "test@example.com",
    paymentMethod: "transfer"
  };
  
  try {
    // Test validation
    const isValid = validateEventRegistrationData(testData);
    console.log(isValid ? '‚úÖ Validation: PASS' : '‚ùå Validation: FAIL');
    
    // Test payment method conversion
    const paymentText = getPaymentMethodText(testData.paymentMethod);
    console.log(paymentText === "Transferencia Bancaria" ? '‚úÖ Payment text: PASS' : '‚ùå Payment text: FAIL');
    
    // Test date formatting
    const dateText = formatDateSpanish(new Date());
    console.log(dateText && dateText.length > 0 ? '‚úÖ Date format: PASS' : '‚ùå Date format: FAIL');
    
    console.log('üèÅ Smoke test complete');
    
  } catch (error) {
    console.error('üí• Smoke test failed:', error);
  }
}

/**
 * Performance test for high-volume scenarios
 */
function performanceTest() {
  console.log('‚ö° Running performance test...');
  
  const startTime = new Date().getTime();
  const iterations = 50;
  
  const testData = {
    firstName: "Performance",
    lastName: "Test",
    phone: "+57 300 999 8888",
    email: "perf.test@example.com",
    paymentMethod: "card"
  };
  
  try {
    for (let i = 0; i < iterations; i++) {
      validateEventRegistrationData(testData);
      getPaymentMethodText(testData.paymentMethod);
      formatDateSpanish(new Date());
    }
    
    const endTime = new Date().getTime();
    const avgTime = (endTime - startTime) / iterations;
    
    console.log(`üìä Performance Results:`);
    console.log(`   Total time: ${endTime - startTime}ms`);
    console.log(`   Average per operation: ${avgTime.toFixed(2)}ms`);
    console.log(`   Operations per second: ${(1000 / avgTime).toFixed(0)}`);
    
    if (avgTime < 10) {
      console.log('‚úÖ Performance: EXCELLENT');
    } else if (avgTime < 50) {
      console.log('‚úÖ Performance: GOOD');
    } else {
      console.log('‚ö†Ô∏è Performance: NEEDS OPTIMIZATION');
    }
    
  } catch (error) {
    console.error('üí• Performance test failed:', error);
  }
}

/**
 * Test data factory for creating test scenarios
 */
function createTestData(overrides = {}) {
  const baseData = {
    firstName: "Test",
    lastName: "User",
    phone: "+57 300 123 4567",
    email: "test@example.com",
    paymentMethod: "transfer",
    source: "test-suite"
  };
  
  return { ...baseData, ...overrides };
}

/**
 * Utility function to log test results in a formatted way
 */
function logTestResult(testName, passed, message = '') {
  const status = passed ? '‚úÖ PASS' : '‚ùå FAIL';
  const msg = message ? ` - ${message}` : '';
  console.log(`  ${testName}: ${status}${msg}`);
}